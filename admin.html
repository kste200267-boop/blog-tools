<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ â€” êµì‚¬ ì‹¤ë¬´ ìë™í™” ì„¼í„°</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3345;
  --text:#e2e5f0;--sub:#8b90a5;--primary:#6366f1;--primary-lt:#818cf820;
  --green:#22c55e;--red:#ef4444;--yellow:#eab308;--blue:#3b82f6;
  --radius:12px;--font:'Pretendard','Noto Sans KR',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
button{font-family:var(--font);cursor:pointer}
input,select,textarea{font-family:var(--font);background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:.9rem;width:100%;outline:none;transition:border .2s}
input:focus,select:focus,textarea:focus{border-color:var(--primary)}
textarea{resize:vertical;min-height:60px}

/* ë¡œê·¸ì¸ */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px}
.login-overlay .logo{font-size:3rem}
.login-overlay h2{font-weight:800;font-size:1.4rem}
.login-overlay input{max-width:280px;text-align:center;font-size:1.1rem;letter-spacing:4px}
.login-overlay .login-btn{padding:12px 40px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;transition:transform .2s}
.login-overlay .login-btn:hover{transform:scale(1.03)}
.login-overlay .login-err{color:var(--red);font-size:.85rem;min-height:20px}

/* ë ˆì´ì•„ì›ƒ */
.top-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.top-bar h1{font-size:1.1rem;font-weight:800;display:flex;align-items:center;gap:8px}
.top-bar .actions{display:flex;gap:8px}
.main{max-width:960px;margin:0 auto;padding:24px 16px 80px}

/* íƒ­ */
.tabs{display:flex;gap:4px;margin-bottom:24px;border-bottom:2px solid var(--border);padding-bottom:0}
.tab{padding:12px 20px;background:none;border:none;color:var(--sub);font-size:.9rem;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.tab:hover{color:var(--text)}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* ë²„íŠ¼ */
.btn{padding:8px 18px;border:1px solid var(--border);border-radius:8px;background:var(--surface2);color:var(--text);font-size:.85rem;font-weight:600;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--border)}
.btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
.btn-primary:hover{opacity:.9}
.btn-danger{background:var(--red);border-color:var(--red);color:#fff}
.btn-danger:hover{opacity:.9}
.btn-success{background:var(--green);border-color:var(--green);color:#fff}
.btn-success:hover{opacity:.9}
.btn-sm{padding:6px 12px;font-size:.8rem}

/* ì¹´ë“œ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;transition:border .2s}
.card:hover{border-color:var(--primary)}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.card-header h3{font-size:1rem;font-weight:700}
.card-header .badge{font-size:.75rem;padding:3px 10px;border-radius:20px;background:var(--primary-lt);color:var(--primary)}
.card-body{font-size:.88rem;color:var(--sub);line-height:1.6}
.card-actions{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}

/* í¼ */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:.82rem;font-weight:600;color:var(--sub);margin-bottom:6px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

/* ëª¨ë‹¬ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:560px;width:100%;max-height:85vh;overflow-y:auto}
.modal h2{font-size:1.15rem;font-weight:800;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:24px}

/* ë‹¤ìš´ë¡œë“œ ì˜ì—­ */
.download-zone{background:var(--surface);border:2px dashed var(--border);border-radius:16px;padding:32px;text-align:center;margin-top:20px}
.download-zone h3{font-size:1.1rem;font-weight:700;margin-bottom:12px}
.download-zone p{color:var(--sub);font-size:.88rem;margin-bottom:16px;line-height:1.5}
.download-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* ìƒíƒœ */
.empty{text-align:center;padding:40px;color:var(--sub)}
.empty .icon{font-size:2.5rem;margin-bottom:12px}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--green);color:#fff;padding:12px 28px;border-radius:10px;font-weight:600;font-size:.9rem;transition:transform .3s;z-index:999}
.toast.show{transform:translateX(-50%) translateY(0)}
.tag{display:inline-block;font-size:.72rem;padding:2px 8px;border-radius:10px;background:var(--surface2);color:var(--sub);margin-right:4px}

/* ì•ˆë‚´ ìŠ¤í… */
.steps{display:flex;gap:16px;margin-top:16px;flex-wrap:wrap}
.step{flex:1;min-width:140px;background:var(--surface2);border-radius:10px;padding:16px;text-align:center}
.step .num{width:28px;height:28px;border-radius:50%;background:var(--primary);color:#fff;font-size:.8rem;font-weight:800;display:inline-flex;align-items:center;justify-content:center;margin-bottom:8px}
.step p{font-size:.82rem;color:var(--sub);line-height:1.4}
.step strong{display:block;font-size:.9rem;color:var(--text);margin-bottom:4px}

@media(max-width:640px){
  .form-row,.form-row-3{grid-template-columns:1fr}
  .steps{flex-direction:column}
  .top-bar{flex-direction:column;gap:10px;align-items:flex-start}
}
</style>
</head>
<body>

<!-- ===== ë¡œê·¸ì¸ ===== -->
<div class="login-overlay" id="login-overlay">
  <div class="logo">ğŸ”§</div>
  <h2>ê´€ë¦¬ì ëª¨ë“œ</h2>
  <input type="password" id="pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="20" autofocus>
  <button class="login-btn" onclick="tryLogin()">ë¡œê·¸ì¸</button>
  <div class="login-err" id="login-err"></div>
</div>

<!-- ===== ìƒë‹¨ ë°” ===== -->
<div class="top-bar" id="top-bar" style="display:none">
  <h1>ğŸ”§ êµì‚¬ ì‹¤ë¬´ ìë™í™” ì„¼í„° â€” ê´€ë¦¬ì</h1>
  <div class="actions">
    <button class="btn" onclick="location.href='index.html'">ğŸ  ì‚¬ì´íŠ¸ ë³´ê¸°</button>
    <button class="btn btn-danger btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- ===== ë©”ì¸ ===== -->
<div class="main" id="main-app" style="display:none">

  <div class="tabs">
    <button class="tab active" data-tab="units" onclick="switchTab('units')">ğŸ“š ë‹¨ì› ê´€ë¦¬</button>
    <button class="tab" data-tab="contents" onclick="switchTab('contents')">ğŸ“„ ì½˜í…ì¸  ê´€ë¦¬</button>
    <button class="tab" data-tab="export" onclick="switchTab('export')">ğŸ“¦ ë‚´ë³´ë‚´ê¸°</button>
    <button class="tab" data-tab="guide" onclick="switchTab('guide')">â“ ì‚¬ìš©ë²•</button>
  </div>

  <!-- ===== íƒ­1: ë‹¨ì› ê´€ë¦¬ ===== -->
  <div class="tab-panel active" id="panel-units">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="font-size:1rem;font-weight:700">ë“±ë¡ëœ ë‹¨ì›</h2>
      <button class="btn btn-primary" onclick="openUnitModal()">+ ë‹¨ì› ì¶”ê°€</button>
    </div>
    <div id="unit-list"></div>
  </div>

  <!-- ===== íƒ­2: ì½˜í…ì¸  ê´€ë¦¬ ===== -->
  <div class="tab-panel" id="panel-contents">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <h2 style="font-size:1rem;font-weight:700">ì½˜í…ì¸  ëª©ë¡</h2>
        <select id="content-unit-filter" onchange="renderContents()" style="width:auto;padding:6px 12px;font-size:.85rem">
          <option value="">ì „ì²´ ë‹¨ì›</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="openContentModal()">+ ì½˜í…ì¸  ì¶”ê°€</button>
    </div>
    <div id="content-list"></div>
  </div>

  <!-- ===== íƒ­3: ë‚´ë³´ë‚´ê¸° ===== -->
  <div class="tab-panel" id="panel-export">
    <div class="download-zone">
      <h3>ğŸ“¦ JSON íŒŒì¼ ë‚´ë³´ë‚´ê¸°</h3>
      <p>ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ JSONì„ ë‹¤ìš´ë¡œë“œí•œ í›„,<br>ìƒˆë¡œ ì¶”ê°€í•œ HTML íŒŒì¼ê³¼ í•¨ê»˜ GitHubì— ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
      <div class="download-btns">
        <button class="btn btn-primary" onclick="downloadUnitsJSON()">ğŸ“¥ units.json</button>
        <button class="btn btn-primary" onclick="downloadAllUnitJSONs()">ğŸ“¥ ì „ì²´ unit-*.json</button>
        <button class="btn btn-success" onclick="downloadAllAsZip()">ğŸ“¥ ì „ë¶€ ZIPìœ¼ë¡œ</button>
      </div>
    </div>
    <div class="download-zone" style="margin-top:16px;border-color:var(--yellow)">
      <h3>ğŸ”„ JSON ê°€ì ¸ì˜¤ê¸°</h3>
      <p>ê¸°ì¡´ GitHub ë ˆí¬ì—ì„œ JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ ê´€ë¦¬ì ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤.</p>
      <div class="download-btns">
        <button class="btn" onclick="importFromSite()">ğŸŒ ì‚¬ì´íŠ¸ì—ì„œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn" onclick="document.getElementById('import-file').click()">ğŸ“ íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ</button>
        <input type="file" id="import-file" accept=".json" multiple style="display:none" onchange="importFiles(event)">
      </div>
    </div>
  </div>

  <!-- ===== íƒ­4: ì‚¬ìš©ë²• ===== -->
  <div class="tab-panel" id="panel-guide">
    <div class="card" style="border-color:var(--primary)">
      <h3 style="font-weight:800;margin-bottom:16px">ğŸ“– ì‚¬ìš© ë°©ë²•</h3>
      <div class="steps">
        <div class="step"><div class="num">1</div><strong>ë‹¨ì› ì¶”ê°€</strong><p>ğŸ“š íƒ­ì—ì„œ ë‹¨ì› ì´ë¦„, ì½”ë“œ, íƒœê·¸ ì…ë ¥</p></div>
        <div class="step"><div class="num">2</div><strong>ì½˜í…ì¸  ë“±ë¡</strong><p>ğŸ“„ íƒ­ì—ì„œ íŒŒì¼ëª…, ì œëª©, ìœ í˜• ì…ë ¥</p></div>
        <div class="step"><div class="num">3</div><strong>JSON ë‚´ë³´ë‚´ê¸°</strong><p>ğŸ“¦ íƒ­ì—ì„œ ZIP ë‹¤ìš´ë¡œë“œ</p></div>
        <div class="step"><div class="num">4</div><strong>GitHub ì—…ë¡œë“œ</strong><p>JSON + HTML íŒŒì¼ì„ ë ˆí¬ì— ë“œë˜ê·¸</p></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3 style="font-weight:800;margin-bottom:12px">ğŸ“‚ íŒŒì¼ ì´ë¦„ ê·œì¹™</h3>
      <div class="card-body">
        <p>â€¢ <b>ë‹¨ì› í—ˆë¸Œ:</b> <code>hub-unit-{slug}.html</code> (ìë™ ìƒì„±ë¨)</p>
        <p>â€¢ <b>ë‹¨ì› JSON:</b> <code>unit-{slug}.json</code> (ìë™ ìƒì„±ë¨)</p>
        <p>â€¢ <b>ì½˜í…ì¸ :</b> <code>c-{unit-slug}-{content-slug}.html</code></p>
        <p>â€¢ <b>ì›¹êµêµ¬:</b> <code>w-{ì´ë¦„}.html</code> (ë…ë¦½ ì‹¤í–‰í˜•)</p>
        <p style="margin-top:8px;color:var(--yellow)">âš  í—ˆë¸Œ HTMLì€ í•œ ë²ˆë§Œ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤. ì´í›„ JSONë§Œ ì—…ë°ì´íŠ¸í•˜ë©´ ì½˜í…ì¸ ê°€ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3 style="font-weight:800;margin-bottom:12px">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="password" id="new-pw" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="max-width:200px">
        <button class="btn btn-primary btn-sm" onclick="changePW()">ë³€ê²½</button>
      </div>
    </div>
  </div>

</div>

<!-- ===== ë‹¨ì› ëª¨ë‹¬ ===== -->
<div class="modal-overlay" id="unit-modal">
  <div class="modal">
    <h2 id="unit-modal-title">ğŸ“š ë‹¨ì› ì¶”ê°€</h2>
    <input type="hidden" id="unit-edit-idx" value="-1">
    <div class="form-row">
      <div class="form-group"><label>ë‹¨ì› ì½”ë“œ (I, II, III...)</label><input id="u-code" placeholder="I"></div>
      <div class="form-group"><label>slug (ì˜ë¬¸ì†Œë¬¸ì-í•˜ì´í”ˆ)</label><input id="u-slug" placeholder="integrated-perspective"></div>
    </div>
    <div class="form-group"><label>ë‹¨ì›ëª…</label><input id="u-title" placeholder="í†µí•©ì  ê´€ì ìœ¼ë¡œ ë°”ë¼ë³´ëŠ” ì‚¬íšŒ"></div>
    <div class="form-group"><label>ë¶€ì œ</label><input id="u-subtitle" placeholder="ì‹œê°„Â·ê³µê°„Â·ì‚¬íšŒÂ·ìœ¤ë¦¬ì  ê´€ì ì˜ í†µí•©"></div>
    <div class="form-group"><label>ì„±ì·¨ê¸°ì¤€</label><textarea id="u-achievement" placeholder="[10í†µì‚¬1-01-01] ì‹œê°„ì , ê³µê°„ì ..."></textarea></div>
    <div class="form-group"><label>íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label><input id="u-tags" placeholder="í†µì‚¬1, ê¸°ì´ˆ"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('unit-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveUnit()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ===== ì½˜í…ì¸  ëª¨ë‹¬ ===== -->
<div class="modal-overlay" id="content-modal">
  <div class="modal">
    <h2 id="content-modal-title">ğŸ“„ ì½˜í…ì¸  ì¶”ê°€</h2>
    <input type="hidden" id="c-edit-unit" value="">
    <input type="hidden" id="c-edit-idx" value="-1">
    <div class="form-group"><label>ì†Œì† ë‹¨ì›</label>
      <select id="c-unit" style="width:100%"><option value="">ë‹¨ì› ì„ íƒ</option></select>
    </div>
    <div class="form-row">
      <div class="form-group"><label>ì½˜í…ì¸  slug</label><input id="c-slug" placeholder="lesson-flow"></div>
      <div class="form-group"><label>íŒŒì¼ëª… (.html)</label><input id="c-file" placeholder="c-economy-lesson-flow.html"></div>
    </div>
    <div class="form-group"><label>ì œëª©</label><input id="c-title" placeholder="1ì°¨ì‹œ ìˆ˜ì—… íë¦„"></div>
    <div class="form-group"><label>ì„¤ëª…</label><input id="c-desc" placeholder="ìì‚° ê´€ë¦¬ 3ì›ì¹™ ë„ì…ë¶€í„° ì •ë¦¬ê¹Œì§€"></div>
    <div class="form-row-3">
      <div class="form-group"><label>ìœ í˜•</label>
        <select id="c-type"><option>ì›¹êµêµ¬</option><option>ìˆ˜ì—…ìë£Œ</option><option>í•™ìŠµì§€</option><option>í™œë™ì§€</option><option>ë¬¸í•­</option><option>êµì‚¬ìš©</option></select>
      </div>
      <div class="form-group"><label>ë‚œì´ë„</label>
        <select id="c-diff"><option>ë³´í†µ</option><option>ì‰¬ì›€</option><option>ë§¤ìš° ì‰¬ì›€</option><option>ì‹¬í™”</option></select>
      </div>
      <div class="form-group"><label>ì†Œìš”ì‹œê°„</label><input id="c-dur" placeholder="15ë¶„"></div>
    </div>
    <div class="form-group"><label>íƒœê·¸ (ì‰¼í‘œ êµ¬ë¶„)</label><input id="c-tags" placeholder="í€´ì¦ˆ, 4ê´€ì , í†µì‚¬1"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('content-modal')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveContent()">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== ë°ì´í„° =====
const STORAGE_KEY = 'admin_blog_tools_v1';
const DEFAULT_PW = '1234';
let DATA = { pw: DEFAULT_PW, units: [], unitContents: {} }; // unitContents: {slug: {unit,unitSlug,achievementStandard,contents:[]}}

function loadData(){
  try{ const d = localStorage.getItem(STORAGE_KEY); if(d) DATA = JSON.parse(d); } catch(e){}
  if(!DATA.pw) DATA.pw = DEFAULT_PW;
  if(!DATA.units) DATA.units = [];
  if(!DATA.unitContents) DATA.unitContents = {};
}
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); }

// ===== ë¡œê·¸ì¸ =====
function tryLogin(){
  const pw = document.getElementById('pw-input').value;
  if(pw === DATA.pw){
    document.getElementById('login-overlay').style.display='none';
    document.getElementById('top-bar').style.display='';
    document.getElementById('main-app').style.display='';
    renderAll();
  } else {
    document.getElementById('login-err').textContent='ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤';
  }
}
function logout(){ location.reload(); }
function changePW(){
  const v = document.getElementById('new-pw').value.trim();
  if(v.length < 2){ toast('2ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”','red'); return; }
  DATA.pw = v;
  saveData();
  toast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
}
document.getElementById('pw-input').addEventListener('keydown',e=>{if(e.key==='Enter')tryLogin()});

// ===== íƒ­ =====
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active', p.id==='panel-'+tab));
  if(tab==='contents') renderContents();
}

// ===== ë Œë” =====
function renderAll(){ renderUnits(); renderContents(); renderUnitSelectors(); }

function renderUnits(){
  const el = document.getElementById('unit-list');
  if(!DATA.units.length){ el.innerHTML='<div class="empty"><div class="icon">ğŸ“­</div><p>ë“±ë¡ëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤. + ë‹¨ì› ì¶”ê°€ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”.</p></div>'; return; }
  el.innerHTML = DATA.units.map((u,i)=>{
    const cc = (DATA.unitContents[u.slug]?.contents||[]).length;
    return `<div class="card">
      <div class="card-header">
        <h3>${u.code}. ${u.title}</h3>
        <span class="badge">ì½˜í…ì¸  ${cc}ê°œ</span>
      </div>
      <div class="card-body">
        <p>${u.subtitle}</p>
        <p style="margin-top:4px">${u.tags.map(t=>'<span class="tag">'+t+'</span>').join('')} <span class="tag" style="background:var(--primary-lt);color:var(--primary)">slug: ${u.slug}</span></p>
      </div>
      <div class="card-actions">
        <button class="btn btn-sm" onclick="editUnit(${i})">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-sm btn-danger" onclick="deleteUnit(${i})">ğŸ—‘ ì‚­ì œ</button>
        <button class="btn btn-sm" onclick="switchTab('contents');document.getElementById('content-unit-filter').value='${u.slug}';renderContents()">ğŸ“„ ì½˜í…ì¸  ë³´ê¸°</button>
      </div>
    </div>`}).join('');
}

function renderContents(){
  const el = document.getElementById('content-list');
  const filter = document.getElementById('content-unit-filter').value;
  let items = [];
  for(const slug in DATA.unitContents){
    const uc = DATA.unitContents[slug];
    if(filter && slug !== filter) continue;
    (uc.contents||[]).forEach((c,i)=>{
      items.push({...c, unitSlug:slug, unitTitle:uc.unit, idx:i});
    });
  }
  if(!items.length){ el.innerHTML='<div class="empty"><div class="icon">ğŸ“­</div><p>ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>'; return; }
  el.innerHTML = items.map(c=>`<div class="card">
    <div class="card-header">
      <h3>${c.title}</h3>
      <span class="badge">${c.type}</span>
    </div>
    <div class="card-body">
      <p>${c.desc}</p>
      <p style="margin-top:4px"><span class="tag">${c.unitTitle}</span><span class="tag">${c.difficulty}</span><span class="tag">â±${c.duration}</span><span class="tag" style="background:var(--primary-lt);color:var(--primary)">${c.file}</span></p>
    </div>
    <div class="card-actions">
      <button class="btn btn-sm" onclick="editContent('${c.unitSlug}',${c.idx})">âœï¸ ìˆ˜ì •</button>
      <button class="btn btn-sm btn-danger" onclick="deleteContent('${c.unitSlug}',${c.idx})">ğŸ—‘ ì‚­ì œ</button>
    </div>
  </div>`).join('');
}

function renderUnitSelectors(){
  const opts = DATA.units.map(u=>`<option value="${u.slug}">${u.code}. ${u.title}</option>`).join('');
  document.getElementById('content-unit-filter').innerHTML = '<option value="">ì „ì²´ ë‹¨ì›</option>' + opts;
  document.getElementById('c-unit').innerHTML = '<option value="">ë‹¨ì› ì„ íƒ</option>' + opts;
}

// ===== ë‹¨ì› CRUD =====
function openUnitModal(){ 
  document.getElementById('unit-edit-idx').value = -1;
  document.getElementById('unit-modal-title').textContent = 'ğŸ“š ë‹¨ì› ì¶”ê°€';
  ['u-code','u-slug','u-title','u-subtitle','u-achievement','u-tags'].forEach(id=>document.getElementById(id).value='');
  openModal('unit-modal');
}
function editUnit(i){
  const u = DATA.units[i];
  document.getElementById('unit-edit-idx').value = i;
  document.getElementById('unit-modal-title').textContent = 'ğŸ“š ë‹¨ì› ìˆ˜ì •';
  document.getElementById('u-code').value = u.code;
  document.getElementById('u-slug').value = u.slug;
  document.getElementById('u-title').value = u.title;
  document.getElementById('u-subtitle').value = u.subtitle;
  document.getElementById('u-achievement').value = DATA.unitContents[u.slug]?.achievementStandard || '';
  document.getElementById('u-tags').value = u.tags.join(', ');
  openModal('unit-modal');
}
function saveUnit(){
  const idx = parseInt(document.getElementById('unit-edit-idx').value);
  const slug = document.getElementById('u-slug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g,'');
  const code = document.getElementById('u-code').value.trim();
  const title = document.getElementById('u-title').value.trim();
  const subtitle = document.getElementById('u-subtitle').value.trim();
  const achievement = document.getElementById('u-achievement').value.trim();
  const tags = document.getElementById('u-tags').value.split(',').map(t=>t.trim()).filter(Boolean);
  if(!slug||!title){ toast('slugê³¼ ë‹¨ì›ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤','red'); return; }
  
  const unit = {slug,code,title,subtitle,tags,contentCount:0};
  
  if(idx === -1){
    // ìƒˆë¡œ ì¶”ê°€
    if(DATA.units.find(u=>u.slug===slug)){ toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” slugì…ë‹ˆë‹¤','red'); return; }
    DATA.units.push(unit);
    DATA.unitContents[slug] = {unit:title, unitSlug:slug, achievementStandard:achievement, contents:[]};
  } else {
    // ìˆ˜ì •
    const oldSlug = DATA.units[idx].slug;
    DATA.units[idx] = unit;
    if(oldSlug !== slug){
      DATA.unitContents[slug] = DATA.unitContents[oldSlug] || {unit:title,unitSlug:slug,achievementStandard:achievement,contents:[]};
      delete DATA.unitContents[oldSlug];
    }
    DATA.unitContents[slug].unit = title;
    DATA.unitContents[slug].unitSlug = slug;
    DATA.unitContents[slug].achievementStandard = achievement;
  }
  updateContentCounts();
  saveData();
  closeModal('unit-modal');
  renderAll();
  toast(idx===-1?'ë‹¨ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤':'ë‹¨ì›ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
}
function deleteUnit(i){
  if(!confirm(`"${DATA.units[i].title}" ë‹¨ì›ê³¼ ì†Œì† ì½˜í…ì¸ ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  const slug = DATA.units[i].slug;
  DATA.units.splice(i,1);
  delete DATA.unitContents[slug];
  saveData(); renderAll();
  toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ===== ì½˜í…ì¸  CRUD =====
function openContentModal(){
  document.getElementById('c-edit-unit').value = '';
  document.getElementById('c-edit-idx').value = -1;
  document.getElementById('content-modal-title').textContent = 'ğŸ“„ ì½˜í…ì¸  ì¶”ê°€';
  ['c-slug','c-file','c-title','c-desc','c-dur','c-tags'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('c-unit').value = document.getElementById('content-unit-filter').value || '';
  openModal('content-modal');
}
function editContent(unitSlug, idx){
  const c = DATA.unitContents[unitSlug].contents[idx];
  document.getElementById('c-edit-unit').value = unitSlug;
  document.getElementById('c-edit-idx').value = idx;
  document.getElementById('content-modal-title').textContent = 'ğŸ“„ ì½˜í…ì¸  ìˆ˜ì •';
  document.getElementById('c-unit').value = unitSlug;
  document.getElementById('c-slug').value = c.slug;
  document.getElementById('c-file').value = c.file;
  document.getElementById('c-title').value = c.title;
  document.getElementById('c-desc').value = c.desc;
  document.getElementById('c-type').value = c.type;
  document.getElementById('c-diff').value = c.difficulty;
  document.getElementById('c-dur').value = c.duration;
  document.getElementById('c-tags').value = c.tags.join(', ');
  openModal('content-modal');
}
function saveContent(){
  const editUnit = document.getElementById('c-edit-unit').value;
  const editIdx = parseInt(document.getElementById('c-edit-idx').value);
  const unitSlug = document.getElementById('c-unit').value;
  if(!unitSlug){ toast('ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”','red'); return; }
  
  const c = {
    slug: document.getElementById('c-slug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g,''),
    file: document.getElementById('c-file').value.trim(),
    title: document.getElementById('c-title').value.trim(),
    desc: document.getElementById('c-desc').value.trim(),
    type: document.getElementById('c-type').value,
    difficulty: document.getElementById('c-diff').value,
    duration: document.getElementById('c-dur').value.trim(),
    tags: document.getElementById('c-tags').value.split(',').map(t=>t.trim()).filter(Boolean)
  };
  if(!c.slug||!c.title||!c.file){ toast('slug, ì œëª©, íŒŒì¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤','red'); return; }
  
  if(!DATA.unitContents[unitSlug]) DATA.unitContents[unitSlug]={unit:'',unitSlug:unitSlug,achievementStandard:'',contents:[]};
  
  if(editIdx === -1){
    DATA.unitContents[unitSlug].contents.push(c);
  } else {
    if(editUnit && editUnit !== unitSlug){
      DATA.unitContents[editUnit].contents.splice(editIdx,1);
      DATA.unitContents[unitSlug].contents.push(c);
    } else {
      DATA.unitContents[unitSlug].contents[editIdx] = c;
    }
  }
  updateContentCounts();
  saveData();
  closeModal('content-modal');
  renderContents(); renderUnits();
  toast(editIdx===-1?'ì½˜í…ì¸ ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤':'ì½˜í…ì¸ ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
}
function deleteContent(unitSlug, idx){
  const c = DATA.unitContents[unitSlug].contents[idx];
  if(!confirm(`"${c.title}"ì„(ë¥¼) ì‚­ì œí•©ë‹ˆë‹¤.`)) return;
  DATA.unitContents[unitSlug].contents.splice(idx,1);
  updateContentCounts();
  saveData(); renderContents(); renderUnits();
  toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updateContentCounts(){
  DATA.units.forEach(u=>{
    u.contentCount = (DATA.unitContents[u.slug]?.contents||[]).length;
  });
}

// ===== ëª¨ë‹¬ =====
function openModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.modal-overlay').forEach(m=>{
  m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('show'); });
});

// ===== ë‚´ë³´ë‚´ê¸° =====
function generateUnitsJSON(){
  return JSON.stringify({
    _comment: "â˜… admin.htmlì—ì„œ ìë™ ìƒì„±ëœ íŒŒì¼ì…ë‹ˆë‹¤.",
    subject: "í†µí•©ì‚¬íšŒ",
    curriculum: "2022 ê°œì • êµìœ¡ê³¼ì •",
    units: DATA.units.map(u=>({slug:u.slug,code:u.code,title:u.title,subtitle:u.subtitle,tags:u.tags,contentCount:u.contentCount}))
  }, null, 2);
}
function generateUnitJSON(slug){
  const uc = DATA.unitContents[slug];
  if(!uc) return null;
  return JSON.stringify({
    unit: uc.unit,
    unitSlug: uc.unitSlug,
    achievementStandard: uc.achievementStandard,
    contents: uc.contents
  }, null, 2);
}
function downloadFile(name, content){
  const blob = new Blob([content],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}
function downloadUnitsJSON(){ downloadFile('units.json', generateUnitsJSON()); toast('units.json ë‹¤ìš´ë¡œë“œ ì™„ë£Œ'); }
function downloadAllUnitJSONs(){
  DATA.units.forEach(u=>{
    const json = generateUnitJSON(u.slug);
    if(json) downloadFile(`unit-${u.slug}.json`, json);
  });
  toast(`${DATA.units.length}ê°œ unit JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
}
async function downloadAllAsZip(){
  // ê°„ë‹¨í•œ ZIP (JSZip CDN ì—†ì´ ê°œë³„ ë‹¤ìš´ë¡œë“œ)
  downloadFile('units.json', generateUnitsJSON());
  await new Promise(r=>setTimeout(r,300));
  for(const u of DATA.units){
    const json = generateUnitJSON(u.slug);
    if(json){ downloadFile(`unit-${u.slug}.json`, json); await new Promise(r=>setTimeout(r,300)); }
  }
  toast('ì „ì²´ JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! GitHubì— ì—…ë¡œë“œí•˜ì„¸ìš”.');
}

// ===== ê°€ì ¸ì˜¤ê¸° =====
async function importFromSite(){
  try{
    toast('ì‚¬ì´íŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    const res = await fetch('units.json');
    if(!res.ok) throw new Error('units.json ì—†ìŒ');
    const unitsData = await res.json();
    DATA.units = unitsData.units || [];
    
    for(const u of DATA.units){
      try{
        const r2 = await fetch(`unit-${u.slug}.json`);
        if(r2.ok) DATA.unitContents[u.slug] = await r2.json();
      }catch(e2){}
    }
    updateContentCounts();
    saveData(); renderAll();
    toast(`${DATA.units.length}ê°œ ë‹¨ì› ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!`);
  }catch(e){
    toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message, 'red');
  }
}
function importFiles(event){
  const files = event.target.files;
  let count = 0;
  Array.from(files).forEach(file=>{
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const json = JSON.parse(e.target.result);
        if(json.units){
          // units.json
          DATA.units = json.units;
          count++;
        } else if(json.unitSlug){
          // unit-*.json
          DATA.unitContents[json.unitSlug] = json;
          count++;
        }
        updateContentCounts();
        saveData(); renderAll();
        toast(`${count}ê°œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`);
      }catch(err){ toast('íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨','red'); }
    };
    reader.readAsText(file);
  });
  event.target.value = '';
}

// ===== í† ìŠ¤íŠ¸ =====
function toast(msg, color){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.background = color==='red' ? 'var(--red)' : 'var(--green)';
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 2500);
}

// ===== ì´ˆê¸°í™” =====
loadData();
</script>
</body>
</html>
